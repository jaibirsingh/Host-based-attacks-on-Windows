# Windows access tokens
* A core element of the authentication process on Windows.
* Created and managed by the Local Authority Subsystem Service (LSASS) ---> lsass.exe --> name of the process for the files with tokens.
* It can be thought of as a temporary key akin to a web cookie that provides access to a system or network resource without providing credentials each time a system resource is accessed.
* **What do they contain**
  * They include the identity and privileges of the user account associated with the thread or process. 
* **How are they generated**
    * Generated by the winlogon.exe process every time a user authenticates successfully.
    * This token is then attached to the userinit.exe process --> after which all child processes started by a user will inherit a copy of the access token from their creator and will run under the privilege of the same access token.
 
* **Security levels**
  * Security levels assigned to the access tokens determine the privileges of a token.
  * Typically two types of security levels:
    * **Impersonate-level tokens** -->
      * Created as a direct result of a non-interactive login on Windows --> Typically through system services or domain logons.
      * Can be used to impersonate a token only on the local system and not on any external systems that utilize the token.
    * **Delegate-level tokens** --->
      * Created through an interactive login on Windows --> Primarly through a traditional login or through remote access protocols like RDP.
      * These pose the largest threat as they can be used to impersonate tokens on any system.
     
* **Windows Privileges**
  * The process of impersonating access tokens to elevate privileges ---> depends on the privileges assigned to the account  --> Which type of tokens are associated: Impersonation or Delegate tokens.
  * Privileges required for a successful impersonation attack:
    1. SeAssignPrimaryToken ---> Allows a user to impersonate tokens
    2. SeCreateToken ---> Allows a user to create an arbitrary token with administrative privileges.
    3. SelmpersonatePrivilege ---> Allows to create a process under the security context of another user with administrative priviliges.
   

* Practical
  * `service postgresql start && msfconsole`---> `use exploit/windows/http/rejetto_hfs_exec`
  * Migrate the meterpreter session to a different process named explorer using --> `pgrep explorer` --> `migrate [ID fetched from the previous command]`
  * This command will show the error:"Access denied" because of the low privileges.
  * The privileges can also be confirmed by: `getprivs`
  * `load incognito`
  * `list tokens -u` ---> To list all the token with usernames (-u) on the target system.
  * As we have "SeImpersonatePrivilege", we can impersonate using: `impersonate_token "[Token name from the rpevious command]"`
  * Check again with getuid and try migrating the process, it will allow with escalated privileges.
 
  * **Case: Where no access token exists**
    * POTATO ATTACK
      * This attack will generate an NT Authority/System token to be impersonated
